<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="theblackbox.css">
</head>
<body>

<div class="tab">
	<button class="tablinks" onclick="openPanel(event, 'panel-login')" id="defaultOpen">Login</button>
	<button class="tablinks" onclick="openPanel(event, 'panel-new-player')">New Player</button>
</div>

<div id="panel-login" class="tabcontent">
	<h3>Login</h3>

	<br />

	<div class="login-player-details">
	<div class="login-player-text">
	Enter player name
	</div>
	<div class="login-player-entry">
	<input type="text" id="player-name" style="width: 40%;" oninput="checkPlayerName(event)" onfocus="oskShow(this)" />
	</div>
	</div>

	<br />

	<div class="login-player-details">
	<div class="login-player-text">
	Enter PIN
	</div>
	<div class="login-player-entry">
	<input type="password" id="player-pin" style="width: 10%;" oninput="checkPIN(event)" onfocus="oskShow(this)" />
	</div>
	</div>

	<br />

	<div class="login-player-details">
	<div class="login-player-text">
	</div>
	<div class="login-player-entry">
	<input type="button" id="login" value="Login" onclick="playerLogin()" />
	</div>
	</div>

	<br />

	<div class="login-player-details">
        <div class="login-player-text">
        </div>
	<div id="login-player-error" class="login-player-entry" style="display:none;">
	</div>
	</div>
</div>

<div id="panel-new-player" class="tabcontent">
	<h3>New Player</h3>
	<p>Please enter details.</p>

	<div class="new-player-details">
	<div class="new-player-text">
	Player Name
	</div>
	<div class="new-player-entry">
	<input type="text" id="new-player-name" style="width: 40%;" oninput="checkPlayerName(event)" onfocus="oskShow(this)" />
	</div>
	</div>

	<div class="new-player-details">
	<div class="new-player-text">
	PIN
	</div>
	<div class="new-player-entry">
	<input type="password" id="new-player-pin" style="width: 10%;" oninput="checkPIN(event)" onfocus="oskShow(this)" />
	</div>
	</div>

	<div class="new-player-details">
	<div class="new-player-text">
	Full Name
	</div>
	<div class="new-player-entry">
	<input type="text" id="new-player-full-name" style="width: 50%;" oninput="checkFullName(event)" onfocus="oskShow(this)" />
	</div>
	</div>

	<div class="new-player-details">
	<div class="new-player-text">
	Email Address
	</div>
	<div class="new-player-entry">
	<input type="text" id="new-player-email-address" style="width: 75%;" oninput="checkEmailAddress(event)" onfocus="oskShow(this)" />
	</div>
	</div>

	<br/>

	<div class="new-player-details">
	<div class="new-player-text">
	</div>
	<div class="new-player-entry">
	<input type="button" id="submit" value="Register" onclick="playerCreate()" />
	</div>
	</div>

	<br />

	<div class="new-player-details">
	<div class="new-player-text">
	</div>
	<div id="new-player-error" class="new-player-entry" style="display:none;">
	</div>
	</div>
</div>

<div id="panel-message" class="tabcontent">

	<br /><br />
	<br /><br />

	<div id="message-block" style="text-align: center;" >
	</div>

	<br /><br />
	<br /><br />

</div>

<div id="osk-overlay" style="display:none;position:fixed;bottom:0;left:0;width:100%;z-index:9999;background:#111;border-top:2px solid #c00;padding:5px;box-sizing:border-box;">
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;">
<button type="button" onclick="oskPress('1')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">1</button>
<button type="button" onclick="oskPress('2')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">2</button>
<button type="button" onclick="oskPress('3')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">3</button>
<button type="button" onclick="oskPress('4')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">4</button>
<button type="button" onclick="oskPress('5')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">5</button>
<button type="button" onclick="oskPress('6')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">6</button>
<button type="button" onclick="oskPress('7')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">7</button>
<button type="button" onclick="oskPress('8')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">8</button>
<button type="button" onclick="oskPress('9')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">9</button>
<button type="button" onclick="oskPress('0')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">0</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;">
<button type="button" onclick="oskPress('Q')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">q</button>
<button type="button" onclick="oskPress('W')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">w</button>
<button type="button" onclick="oskPress('E')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">e</button>
<button type="button" onclick="oskPress('R')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">r</button>
<button type="button" onclick="oskPress('T')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">t</button>
<button type="button" onclick="oskPress('Y')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">y</button>
<button type="button" onclick="oskPress('U')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">u</button>
<button type="button" onclick="oskPress('I')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">i</button>
<button type="button" onclick="oskPress('O')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">o</button>
<button type="button" onclick="oskPress('P')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">p</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;">
<button type="button" onclick="oskPress('A')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">a</button>
<button type="button" onclick="oskPress('S')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">s</button>
<button type="button" onclick="oskPress('D')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">d</button>
<button type="button" onclick="oskPress('F')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">f</button>
<button type="button" onclick="oskPress('G')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">g</button>
<button type="button" onclick="oskPress('H')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">h</button>
<button type="button" onclick="oskPress('J')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">j</button>
<button type="button" onclick="oskPress('K')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">k</button>
<button type="button" onclick="oskPress('L')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">l</button>
<button type="button" onclick="oskPress('@')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">@</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;">
<button type="button" onclick="oskToggleShift()" style="width:14%;height:42px;background:#220;border:1px solid #660;color:#fc0;font-size:11px;font-weight:bold;border-radius:4px;" id="osk-shift-btn">A/a</button>
<button type="button" onclick="oskPress('Z')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">z</button>
<button type="button" onclick="oskPress('X')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">x</button>
<button type="button" onclick="oskPress('C')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">c</button>
<button type="button" onclick="oskPress('V')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">v</button>
<button type="button" onclick="oskPress('B')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">b</button>
<button type="button" onclick="oskPress('N')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">n</button>
<button type="button" onclick="oskPress('M')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">m</button>
<button type="button" onclick="oskPress('.')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">.</button>
<button type="button" onclick="oskPress('DEL')" style="width:14%;height:42px;background:#300;border:1px solid #c00;color:#c00;font-size:11px;font-weight:bold;border-radius:4px;">WISSEN</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;">
<button type="button" onclick="oskPress('SPACE')" style="width:60%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">SPATIE</button>
<button type="button" onclick="oskPress('DONE')" style="width:35%;height:42px;background:#030;border:1px solid #0c0;color:#0c0;font-size:14px;font-weight:bold;border-radius:4px;">KLAAR</button>
</div>
</div>

<script>
// REST server address
var theBlackBoxBaseURL="http://localhost:5000/"
var oskActiveInput=null;
var oskShiftOn=false;

function oskShow(inp){
	oskActiveInput=inp;
	document.getElementById('osk-overlay').style.display='block';
}
function oskHide(){
	document.getElementById('osk-overlay').style.display='none';
	oskActiveInput=null;
}
function oskPress(key){
	if(!oskActiveInput)return;
	if(key=='DONE'){oskHide();return;}
	if(key=='DEL'){oskActiveInput.value=oskActiveInput.value.slice(0,-1);oskFireInput();return;}
	if(key=='SPACE'){oskActiveInput.value+=' ';}
	else{oskActiveInput.value+=oskShiftOn?key.toUpperCase():key.toLowerCase();}
	oskFireInput();
}
function oskFireInput(){
	if(!oskActiveInput)return;
	var e=new Event('input',{bubbles:true});
	oskActiveInput.dispatchEvent(e);
}
function oskToggleShift(){
	oskShiftOn=!oskShiftOn;
	document.getElementById('osk-shift-btn').style.background=oskShiftOn?'#440':'#220';
	var btns=document.getElementById('osk-overlay').querySelectorAll('button');
	for(var i=0;i<btns.length;i++){
		var oc=btns[i].getAttribute('onclick');
		if(oc&&oc.match(/oskPress\('[A-Z]'\)/)){
			var letter=oc.charAt(10);
			btns[i].textContent=oskShiftOn?letter.toUpperCase():letter.toLowerCase();
		}
	}
}

// Go to highscore page
async function loadHighScorePage() {
	// Create highscore select URL
	let urlLoadHighScorePage = theBlackBoxBaseURL+"page/select?select_page=highscore";
	try {
		// Load login page
		//console.log(urlLoadHighScorePage)
		let response = await fetch(urlLoadHighScorePage);

		// Process response
		responseJSON = await response.json();
		//console.log(responseJSON);
	} catch (error) {
		// Print error
		//console.log(error);
	}
}

// Display selected panel
function openPanel(evt, panelName) {
	let i, tabcontent, tablinks;

        // Hide panels
	tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Deactivate tabs
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}

	// Display panel
	document.getElementById(panelName).style.display = "block";
	// Activate tab
	evt.currentTarget.className += " active";
}

// Display selected panel
function showMessage(message) {
	let i, tabcontent, tablinks;

        // Hide panels
	tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Deactivate tabs
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].style.display = "none";
	}

        // Get message div
        let divElem = document.getElementById("message-block");
	divElem.innerHTML = message;

	// Display panel
	document.getElementById("panel-message").style.display = "block";
}

// Check player name
function checkPlayerName(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^a-z0-9-_ ]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 24);
}

// Check PIN
function checkPIN(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^0-9]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 4);
}

// Check full name
function checkFullName(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^a-z0-9- ]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 64);
}

// Check email address
function checkEmailAddress(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^a-z0-9-_@.]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 255);
}

// Check the string length of the input field generating the event against the given maximum
function checkText(str, txtFilter, maxTxtLen) {
	str = str.replace(txtFilter, "");

	if (str.length > maxTxtLen) {
		// Text lenght is greater than the max, so strip last character
		str = str.substring(0, maxTxtLen);
	}

	return str;
}

// Try to login player
async function playerLogin() {
	// Get player name
	let playerName = document.getElementById("player-name").value;
	// Get PIN
	let pin = document.getElementById("player-pin").value;

	// Build login data block
	let loginData = {
			"player_name": playerName,
			"pin": pin,
	};

	// Create request URL
	let urlPlayerLogin = theBlackBoxBaseURL+"player/login";
	// Send login data
	let response = await fetch(urlPlayerLogin, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(loginData)
	});

	if (response.status === 200) {
		// Login completed
		showMessage("Login succeeded, please wait...");
	} else if (response.status === 403) {
		// Get div element
		let divElem = document.getElementById("login-player-error");

		// Set message
		divElem.innerHTML = "Incorrect player details, please try again."

		// Show message
		divElem.style.display = "block";
	}
}

// Try to create player
async function playerCreate() {
	// Get player name
	let playerName = document.getElementById("new-player-name").value;
	// Get PIN
	let pin = document.getElementById("new-player-pin").value;
	// Get full name
	let fullName = document.getElementById("new-player-full-name").value;
	// Get email address
	let emailAddress = document.getElementById("new-player-email-address").value;

	// Build create data block
	let createData = {
			"player_name": playerName,
			"pin": pin,
			"full_name": fullName,
			"email": emailAddress,
	};

	// Create request URL
	let urlPlayerCreate = theBlackBoxBaseURL+"player/create";
	// Send player data
	let response = await fetch(urlPlayerCreate, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(createData)
	});
	const response_body = await response.json();

	if (response.status === 201) {
		// Player created
		showMessage("Player created, please wait...");
	} else if (response.status === 409) {
		// Get div element
		let divElem = document.getElementById("new-player-error");

		// Set message
		divElem.innerHTML = response_body.error_msg;

		// Show message
		divElem.style.display = "block";
	}
}

// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();

// After 5 mins, load highscore page
setTimeout(loadHighScorePage, 300000);
</script>

</body>
</html>
