<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="theblackbox.css">
</head>
<body>

<!-- Background music - plays on login screen and intro rules -->
<audio id="login-music" src="hauntedintro.mp3" preload="auto" loop></audio>

<div class="tab">
	<button class="tablinks" onclick="openPanel(event, 'panel-login')" id="defaultOpen">Inloggen</button>
	<button class="tablinks" onclick="openPanel(event, 'panel-new-player')">Nieuwe Speler</button>
	<button class="tablinks" onclick="loadHighScorePage()">Highscore</button>
</div>

<div id="panel-login" class="tabcontent">
	<h3>Inloggen</h3>

	<br />

	<div class="login-player-details">
	<div class="login-player-text">
	Spelersnaam
	</div>
	<div class="login-player-entry">
	<input type="text" id="player-name" style="width: 40%;" oninput="checkPlayerName(event)" onfocus="oskShow(this)" data-osk="name" />
	</div>
	</div>

	<br />

	<div class="login-player-details">
	<div class="login-player-text">
	PIN code
	</div>
	<div class="login-player-entry">
	<input type="password" id="player-pin" style="width: 20%;" oninput="checkPIN(event)" onfocus="oskShow(this)" data-osk="pin" />
	</div>
	</div>

	<br />

	<div class="login-player-details">
	<div class="login-player-text">
	</div>
	<div class="login-player-entry">
	<input type="button" id="login" value="Inloggen" onclick="playerLogin()" style="font-size:1.3em;padding:12px 40px;" />
	</div>
	</div>

	<br />

	<div class="login-player-details">
        <div class="login-player-text">
        </div>
	<div id="login-player-error" class="login-player-entry" style="display:none;">
	</div>
	</div>
</div>

<div id="panel-new-player" class="tabcontent">
	<h3>Nieuwe Speler</h3>
	<p>Vul je gegevens in.</p>

	<div class="new-player-details">
	<div class="new-player-text">
	Spelersnaam
	</div>
	<div class="new-player-entry">
	<input type="text" id="new-player-name" style="width: 40%;" oninput="checkPlayerName(event)" onfocus="oskShow(this)" data-osk="name" />
	</div>
	</div>

	<div class="new-player-details">
	<div class="new-player-text">
	PIN code
	</div>
	<div class="new-player-entry">
	<input type="password" id="new-player-pin" style="width: 20%;" oninput="checkPIN(event)" onfocus="oskShow(this)" data-osk="pin" />
	</div>
	</div>

	<div class="new-player-details">
	<div class="new-player-text">
	Volledige Naam
	</div>
	<div class="new-player-entry">
	<input type="text" id="new-player-full-name" style="width: 50%;" oninput="checkFullName(event)" onfocus="oskShow(this)" data-osk="fullname" />
	</div>
	</div>

	<div class="new-player-details">
	<div class="new-player-text">
	E-mailadres
	</div>
	<div class="new-player-entry">
	<input type="text" id="new-player-email-address" style="width: 75%;" oninput="checkEmailAddress(event)" onfocus="oskShow(this)" data-osk="email" />
	</div>
	</div>

	<br/>

	<div class="new-player-details">
	<div class="new-player-text">
	</div>
	<div class="new-player-entry">
	<input type="button" id="submit" value="Registreren" onclick="playerCreate()" style="font-size:1.3em;padding:12px 40px;" />
	</div>
	</div>

	<br />

	<div class="new-player-details">
	<div class="new-player-text">
	</div>
	<div id="new-player-error" class="new-player-entry" style="display:none;">
	</div>
	</div>
</div>

<div id="panel-message" class="tabcontent">

	<br /><br />
	<br /><br />

	<div id="message-block" style="text-align: center;" >
	</div>

	<br /><br />
	<br /><br />

</div>

<div id="panel-intro" class="tabcontent" style="display:none;">
	<div style="max-width:420px;margin:0 auto;padding:10px 20px;text-align:center;">
		<h2 style="color:#fff;text-transform:uppercase;letter-spacing:2px;margin-bottom:12px;font-size:1.2em;">Welkom bij The Black Box</h2>
		<ul style="text-align:left;list-style:none;padding:0;margin:10px 0;">
			<li style="padding:6px 0;border-bottom:1px solid #222;font-size:0.85em;line-height:1.3;padding-left:18px;position:relative;"><span style="position:absolute;left:0;color:#c0392b;">&#9654;</span> Vanaf nu is <strong>alles</strong> wat je ziet onderdeel van het spel</li>
			<li style="padding:6px 0;border-bottom:1px solid #222;font-size:0.85em;line-height:1.3;padding-left:18px;position:relative;"><span style="position:absolute;left:0;color:#c0392b;">&#9654;</span> Elke pagina, elke opdracht en elke interactie telt mee voor je eindscore</li>
			<li style="padding:6px 0;border-bottom:1px solid #222;font-size:0.85em;line-height:1.3;padding-left:18px;position:relative;"><span style="position:absolute;left:0;color:#c0392b;">&#9654;</span> De tijd loopt vanaf nu - wees snel maar zorgvuldig</li>
			<li style="padding:6px 0;border-bottom:1px solid #222;font-size:0.85em;line-height:1.3;padding-left:18px;position:relative;"><span style="position:absolute;left:0;color:#c0392b;">&#9654;</span> Gebruik alles om je heen: je telefoon, het scherm en de aanwijzingen</li>
			<li style="padding:6px 0;font-size:0.85em;line-height:1.3;padding-left:18px;position:relative;"><span style="position:absolute;left:0;color:#c0392b;">&#9654;</span> Het spel eindigt pas als alle challenges zijn voltooid</li>
		</ul>
		<p style="color:#888;font-size:0.8em;font-style:italic;margin-top:10px;">Succes... je gaat het nodig hebben.</p>
		<button id="btn-begrepen" onclick="introBegrepen()" style="margin-top:15px;padding:18px 60px;font-size:1.5em;font-weight:bold;background:#c0392b;color:#fff;border:none;border-radius:8px;cursor:pointer;text-transform:uppercase;letter-spacing:2px;box-shadow:0 0 15px rgba(192,57,43,0.5);">Begrepen</button>
	</div>
</div>

<div id="osk-overlay" style="display:none;position:fixed;bottom:0;left:0;width:100%;z-index:9999;background:#111;border-top:2px solid #c00;padding:5px;box-sizing:border-box;">
<div id="osk-preview" style="background:#1a1a1a;border:1px solid #c00;border-radius:4px;padding:6px 10px;margin-bottom:5px;color:#fff;font-size:14px;font-family:monospace;min-height:20px;display:flex;align-items:center;gap:8px;">
<span id="osk-preview-label" style="color:#888;font-size:11px;white-space:nowrap;"></span>
<span id="osk-preview-value" style="color:#fff;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;" id="osk-row-num">
<button type="button" data-key="1" onclick="oskPress('1')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">1</button>
<button type="button" data-key="2" onclick="oskPress('2')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">2</button>
<button type="button" data-key="3" onclick="oskPress('3')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">3</button>
<button type="button" data-key="4" onclick="oskPress('4')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">4</button>
<button type="button" data-key="5" onclick="oskPress('5')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">5</button>
<button type="button" data-key="6" onclick="oskPress('6')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">6</button>
<button type="button" data-key="7" onclick="oskPress('7')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">7</button>
<button type="button" data-key="8" onclick="oskPress('8')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">8</button>
<button type="button" data-key="9" onclick="oskPress('9')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">9</button>
<button type="button" data-key="0" onclick="oskPress('0')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">0</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;" id="osk-row-q">
<button type="button" data-key="Q" onclick="oskPress('Q')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">q</button>
<button type="button" data-key="W" onclick="oskPress('W')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">w</button>
<button type="button" data-key="E" onclick="oskPress('E')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">e</button>
<button type="button" data-key="R" onclick="oskPress('R')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">r</button>
<button type="button" data-key="T" onclick="oskPress('T')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">t</button>
<button type="button" data-key="Y" onclick="oskPress('Y')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">y</button>
<button type="button" data-key="U" onclick="oskPress('U')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">u</button>
<button type="button" data-key="I" onclick="oskPress('I')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">i</button>
<button type="button" data-key="O" onclick="oskPress('O')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">o</button>
<button type="button" data-key="P" onclick="oskPress('P')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">p</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;" id="osk-row-a">
<button type="button" data-key="A" onclick="oskPress('A')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">a</button>
<button type="button" data-key="S" onclick="oskPress('S')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">s</button>
<button type="button" data-key="D" onclick="oskPress('D')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">d</button>
<button type="button" data-key="F" onclick="oskPress('F')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">f</button>
<button type="button" data-key="G" onclick="oskPress('G')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">g</button>
<button type="button" data-key="H" onclick="oskPress('H')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">h</button>
<button type="button" data-key="J" onclick="oskPress('J')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">j</button>
<button type="button" data-key="K" onclick="oskPress('K')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">k</button>
<button type="button" data-key="L" onclick="oskPress('L')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">l</button>
<button type="button" data-key="@" onclick="oskPress('@')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">@</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;" id="osk-row-z">
<button type="button" data-key="SHIFT" onclick="oskToggleShift()" style="width:14%;height:42px;background:#220;border:1px solid #660;color:#fc0;font-size:11px;font-weight:bold;border-radius:4px;" id="osk-shift-btn">A/a</button>
<button type="button" data-key="Z" onclick="oskPress('Z')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">z</button>
<button type="button" data-key="X" onclick="oskPress('X')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">x</button>
<button type="button" data-key="C" onclick="oskPress('C')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">c</button>
<button type="button" data-key="V" onclick="oskPress('V')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">v</button>
<button type="button" data-key="B" onclick="oskPress('B')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">b</button>
<button type="button" data-key="N" onclick="oskPress('N')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">n</button>
<button type="button" data-key="M" onclick="oskPress('M')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">m</button>
<button type="button" data-key="." onclick="oskPress('.')" style="width:9%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">.</button>
<button type="button" data-key="DEL" onclick="oskPress('DEL')" style="width:14%;height:42px;background:#300;border:1px solid #c00;color:#c00;font-size:11px;font-weight:bold;border-radius:4px;">WISSEN</button>
</div>
<div style="display:flex;gap:3px;margin-bottom:3px;justify-content:center;" id="osk-row-sp">
<button type="button" data-key="SPACE" onclick="oskPress('SPACE')" style="width:60%;height:42px;background:#222;border:1px solid #600;color:#fff;font-size:14px;font-weight:bold;border-radius:4px;">SPATIE</button>
<button type="button" data-key="DONE" onclick="oskPress('DONE')" style="width:35%;height:42px;background:#030;border:1px solid #0c0;color:#0c0;font-size:14px;font-weight:bold;border-radius:4px;">KLAAR</button>
</div>
</div>

<script>
// REST server address
var theBlackBoxBaseURL="http://localhost:5000/"
var oskActiveInput=null;
var oskShiftOn=false;
var oskMode='all';

var oskModes={
	pin:{allow:'0123456789',hideLetters:true,hideAt:true,hideDot:true,hideShift:true,hideSpace:true},
	name:{allow:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_ ',hideAt:true,hideDot:true},
	fullname:{allow:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789- ',hideAt:true,hideDot:true},
	email:{allow:'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_@.',hideSpace:true}
};

function oskApplyMode(mode){
	oskMode=mode;
	var cfg=oskModes[mode]||null;
	var btns=document.getElementById('osk-overlay').querySelectorAll('button[data-key]');
	for(var i=0;i<btns.length;i++){
		var key=btns[i].getAttribute('data-key');
		if(key=='DONE'||key=='DEL'){
			btns[i].style.background='';btns[i].style.color='';btns[i].style.opacity='1';
			btns[i].disabled=false;continue;
		}
		if(!cfg){
			btns[i].style.background='#222';btns[i].style.color='#fff';btns[i].style.opacity='1';
			btns[i].disabled=false;continue;
		}
		var allowed=false;
		if(key=='SPACE'){allowed=!cfg.hideSpace;}
		else if(key=='SHIFT'){allowed=!cfg.hideShift;}
		else if(cfg.allow&&cfg.allow.indexOf(key)>=0){allowed=true;}
		else if(cfg.allow&&key.length==1&&cfg.allow.indexOf(key.toUpperCase())>=0){allowed=true;}
		if(allowed){
			btns[i].style.background='#222';btns[i].style.color='#fff';btns[i].style.opacity='1';
			btns[i].style.borderColor='#600';
			btns[i].disabled=false;
		}else{
			btns[i].style.background='#0a0a0a';btns[i].style.color='#333';btns[i].style.opacity='1';
			btns[i].style.borderColor='#1a1a1a';
			btns[i].disabled=true;
		}
		if(key=='SHIFT'&&allowed){
			btns[i].style.background=oskShiftOn?'#440':'#220';
			btns[i].style.color='#fc0';btns[i].style.borderColor='#660';
		}
	}
}

function oskGetLabel(inp){
	var row=inp.closest('.login-player-details,.new-player-details');
	if(row){
		var lbl=row.querySelector('.login-player-text,.new-player-text');
		if(lbl&&lbl.textContent.trim())return lbl.textContent.trim();
	}
	return '';
}
function oskUpdatePreview(){
	if(!oskActiveInput)return;
	var val=oskActiveInput.value;
	if(oskActiveInput.type=='password')val=val.replace(/./g,'\u2022');
	document.getElementById('osk-preview-value').textContent=val||'\u00a0';
}
function oskShow(inp){
	oskActiveInput=inp;
	document.getElementById('osk-overlay').style.display='block';
	document.getElementById('osk-preview-label').textContent=oskGetLabel(inp);
	oskUpdatePreview();
	oskApplyMode(inp.getAttribute('data-osk')||'all');
	setTimeout(function(){
		inp.scrollIntoView({behavior:'smooth',block:'center'});
	},100);
}
function oskHide(){
	document.getElementById('osk-overlay').style.display='none';
	oskActiveInput=null;
}
function oskPress(key){
	if(!oskActiveInput)return;
	if(key=='DONE'){oskHide();return;}
	if(key=='DEL'){oskActiveInput.value=oskActiveInput.value.slice(0,-1);oskFireInput();return;}
	var cfg=oskModes[oskMode]||null;
	if(cfg&&cfg.allow){
		var ck=(key=='SPACE')?' ':key;
		if(cfg.allow.indexOf(ck.toUpperCase())<0&&cfg.allow.indexOf(ck)<0)return;
	}
	if(key=='SPACE'){oskActiveInput.value+=' ';oskFireInput();return;}
	oskActiveInput.value+=oskShiftOn?key.toUpperCase():key.toLowerCase();
	oskFireInput();
}
function oskFireInput(){
	if(!oskActiveInput)return;
	var e=new Event('input',{bubbles:true});
	oskActiveInput.dispatchEvent(e);
	oskUpdatePreview();
}
function oskToggleShift(){
	oskShiftOn=!oskShiftOn;
	document.getElementById('osk-shift-btn').style.background=oskShiftOn?'#440':'#220';
	var btns=document.getElementById('osk-overlay').querySelectorAll('button');
	for(var i=0;i<btns.length;i++){
		var oc=btns[i].getAttribute('onclick');
		if(oc&&oc.match(/oskPress\('[A-Z]'\)/)){
			var letter=oc.charAt(10);
			btns[i].textContent=oskShiftOn?letter.toUpperCase():letter.toLowerCase();
		}
	}
}

// Go to highscore page
async function loadHighScorePage() {
	// Create highscore select URL
	let urlLoadHighScorePage = theBlackBoxBaseURL+"page/select?select_page=highscore";
	try {
		// Load login page
		//console.log(urlLoadHighScorePage)
		let response = await fetch(urlLoadHighScorePage);

		// Process response
		responseJSON = await response.json();
		//console.log(responseJSON);
	} catch (error) {
		// Print error
		//console.log(error);
	}
}

// Display selected panel
function openPanel(evt, panelName) {
	let i, tabcontent, tablinks;

        // Hide panels
	tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Deactivate tabs
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}

	// Display panel
	document.getElementById(panelName).style.display = "block";
	// Activate tab
	evt.currentTarget.className += " active";
}

// Display selected panel
function showMessage(message) {
	let i, tabcontent, tablinks;

        // Hide panels
	tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Deactivate tabs
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].style.display = "none";
	}

        // Get message div
        let divElem = document.getElementById("message-block");
	divElem.innerHTML = message;

	// Display panel
	document.getElementById("panel-message").style.display = "block";
}

// Check player name
function checkPlayerName(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^a-z0-9-_ ]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 24);
}

// Check PIN
function checkPIN(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^0-9]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 4);
}

// Check full name
function checkFullName(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^a-z0-9- ]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 64);
}

// Check email address
function checkEmailAddress(evt) {
	// First get input element
	let inputElem = document.getElementById(evt.currentTarget.id);

	// Create regex filter (this needs work)
	let regexFilter = /[^a-z0-9-_@.]/ig;

	inputElem.value = checkText(inputElem.value, regexFilter, 255);
}

// Check the string length of the input field generating the event against the given maximum
function checkText(str, txtFilter, maxTxtLen) {
	str = str.replace(txtFilter, "");

	if (str.length > maxTxtLen) {
		// Text lenght is greater than the max, so strip last character
		str = str.substring(0, maxTxtLen);
	}

	return str;
}

// Pending login/create action stored here
var pendingAction = null;

// Show intro rules screen
function showIntro() {
	let i, tabcontent, tablinks;
	// Hide all panels
	tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}
	// Hide tabs
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
		tablinks[i].style.display = "none";
	}
	// Hide keyboard
	oskHide();
	// Show intro panel
	document.getElementById("panel-intro").style.display = "block";
}

// Try to login player - existing account, skip intro, login directly
async function playerLogin() {
	// Get player name
	let playerName = document.getElementById("player-name").value;
	// Get PIN
	let pin = document.getElementById("player-pin").value;

	if (!playerName || !pin) return;

	// Stop background music
	var music = document.getElementById('login-music');
	if (music) { music.pause(); music.currentTime = 0; }

	// Login directly (no intro for existing accounts)
	let response = await fetch(theBlackBoxBaseURL+"player/login", {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ player_name: playerName, pin: pin })
	});
	if (response.status === 200) {
		oskHide();
		showMessage("Het spel begint...");
	} else if (response.status === 403) {
		document.getElementById("login-player-error").innerHTML = "Onjuiste gegevens, probeer het opnieuw.";
		document.getElementById("login-player-error").style.display = "block";
		// Restart music
		if (music) music.play().catch(function(e) {});
	}
}

// Try to create player - shows intro rules first, actual create+login after "Begrepen"
function playerCreate() {
	// Get player name
	let playerName = document.getElementById("new-player-name").value;
	// Get PIN
	let pin = document.getElementById("new-player-pin").value;
	// Get full name
	let fullName = document.getElementById("new-player-full-name").value;
	// Get email address
	let emailAddress = document.getElementById("new-player-email-address").value;

	if (!playerName || !pin || !fullName) return;

	// Store data - create+login happens after "Begrepen"
	pendingAction = {
		type: 'create',
		data: { player_name: playerName, pin: pin, full_name: fullName, email: emailAddress }
	};
	// Show intro rules
	showIntro();
}

// Called when user clicks "Begrepen" on intro screen
async function introBegrepen() {
	// Disable button
	document.getElementById('btn-begrepen').disabled = true;
	document.getElementById('btn-begrepen').innerText = 'Even geduld...';

	// Stop background music
	var music = document.getElementById('login-music');
	if (music) { music.pause(); music.currentTime = 0; }

	try {
		if (pendingAction) {
			if (pendingAction.type === 'create') {
				// First create the player
				let createResponse = await fetch(theBlackBoxBaseURL+"player/create", {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(pendingAction.data)
				});
				if (createResponse.status === 409) {
					var errMsg = "Spelersnaam bestaat al.";
					try { let body = await createResponse.json(); errMsg = body.error_msg || errMsg; } catch(e) {}
					document.getElementById('btn-begrepen').disabled = false;
					document.getElementById('btn-begrepen').innerText = 'Begrepen';
					document.getElementById("panel-intro").style.display = "none";
					openPanel({ currentTarget: document.querySelector('[onclick*="panel-new-player"]') }, 'panel-new-player');
					document.getElementById("new-player-error").innerHTML = errMsg;
					document.getElementById("new-player-error").style.display = "block";
					let tablinks = document.getElementsByClassName("tablinks");
					for (let i = 0; i < tablinks.length; i++) tablinks[i].style.display = "";
					if (music) music.play().catch(function(e) {});
					return;
				} else if (!createResponse.ok) {
					throw new Error("Account aanmaken mislukt (status " + createResponse.status + ")");
				}
			}

			// Now login
			let loginData = { player_name: pendingAction.data.player_name, pin: pendingAction.data.pin };
			let response = await fetch(theBlackBoxBaseURL+"player/login", {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(loginData)
			});
			if (response.status === 200) {
				showMessage("Het spel begint...");
			} else if (response.status === 403) {
				document.getElementById('btn-begrepen').disabled = false;
				document.getElementById('btn-begrepen').innerText = 'Begrepen';
				document.getElementById("panel-intro").style.display = "none";
				openPanel({ currentTarget: document.getElementById('defaultOpen') }, 'panel-login');
				document.getElementById("login-player-error").innerHTML = "Onjuiste gegevens, probeer het opnieuw.";
				document.getElementById("login-player-error").style.display = "block";
				let tablinks = document.getElementsByClassName("tablinks");
				for (let i = 0; i < tablinks.length; i++) tablinks[i].style.display = "";
				if (music) music.play().catch(function(e) {});
			} else {
				throw new Error("Inloggen mislukt (status " + response.status + ")");
			}
		}
	} catch(err) {
		console.log("introBegrepen error:", err);
		document.getElementById('btn-begrepen').disabled = false;
		document.getElementById('btn-begrepen').innerText = 'Begrepen';
		document.getElementById("panel-intro").style.display = "none";
		openPanel({ currentTarget: document.querySelector('[onclick*="panel-new-player"]') }, 'panel-new-player');
		document.getElementById("new-player-error").innerHTML = "Er ging iets mis: " + err.message;
		document.getElementById("new-player-error").style.display = "block";
		let tablinks = document.getElementsByClassName("tablinks");
		for (let i = 0; i < tablinks.length; i++) tablinks[i].style.display = "";
		if (music) music.play().catch(function(e) {});
	}
}

// Start music on first user interaction (autoplay is blocked without interaction)
var musicStarted = false;
function tryStartMusic() {
	if (!musicStarted) {
		var music = document.getElementById('login-music');
		music.play().then(function() { musicStarted = true; }).catch(function(e) {});
	}
}
document.body.addEventListener('click', tryStartMusic);
document.body.addEventListener('touchstart', tryStartMusic);

// Stop any parent music (e.g. soundofsilence from finish/highscore)
try { parent.stopMusic(); } catch(e) {}

// Get the element with id="defaultOpen" and click on it
document.getElementById("defaultOpen").click();

// After 5 mins, load highscore page
setTimeout(loadHighScorePage, 300000);
</script>

</body>
</html>
