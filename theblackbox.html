<html>
<head>
<title>The BlackBox</title>
<link rel="stylesheet" type="text/css" href="theblackbox.css">
<style>
#tbbx-banner { grid-template-columns: 1fr 10fr 2fr 1fr; }
#tbbx-hint-btn { display:flex; align-items:center; justify-content:center; }
#button-hint { background:inherit; border:1px solid #c00; color:#c00; font-size:0.9em; padding:4px 10px; border-radius:5px; cursor:pointer; font-family:inherit; letter-spacing:1px; }
</style>
</head>
<body id="tbbx-body">
<div id="tbbx-banner">

	<span id="tbbx-status"><img id="icon-wifi-connected" class="" src="icons/wifi-grey.32x32.png"> </span>
	<span id="tbbx-player"><center id="tbbx-player-text"></center></span>
	<span id="tbbx-hint-btn"><button id="button-hint" onclick="requestHint()">HINT</button></span>
	<span id="tbbx-logout"><button id="button-player-logout" onclick="playerLogout()"><img id="icon-player-logout" class="" src="icons/power-black.32x32.png" /></button></span>
</div>
<div id="tbbx-challenge"> <iframe id="tbbx-challenge-frame" height="100%" width="100%" style="border: 0px;" allowfullscreen></iframe> </div>

<!-- Tip popup overlay -->
<div id="tip-popup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a0a0a 0%,#2a0a0a 100%);border:3px solid #c00;border-radius:15px;padding:30px 40px;max-width:80%;max-height:60%;z-index:99999;box-shadow:0 0 50px rgba(200,0,0,0.5),inset 0 0 30px rgba(0,0,0,0.5);">
<style>
@keyframes tipPulse { 0%,100%{box-shadow:0 0 50px rgba(200,0,0,0.5),inset 0 0 30px rgba(0,0,0,0.5)} 50%{box-shadow:0 0 70px rgba(200,0,0,0.8),inset 0 0 30px rgba(0,0,0,0.5)} }
</style>
<div style="text-align:center;">
<div style="font-size:1.5em;color:#fc0;margin-bottom:15px;text-transform:uppercase;letter-spacing:3px;">- - - HINT - - -</div>
<div id="tip-message" style="font-size:1.8em;color:#fff;line-height:1.4;margin-bottom:20px;"></div>
<div style="font-size:0.9em;color:#666;margin-top:15px;">Verdwijnt automatisch...</div>
</div>
</div>

<!-- Hint confirm dialog -->
<div id="hint-confirm" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a0a0a,#2a0505);border:3px solid #c00;border-radius:15px;padding:25px 30px;max-width:85%;z-index:100000;box-shadow:0 0 50px rgba(200,0,0,0.6);text-align:center;">
<div style="font-size:1.4em;color:#c00;margin-bottom:12px;">Hint aanvragen?</div>
<div style="font-size:1em;color:#ccc;margin-bottom:18px;line-height:1.4;">Een hint kost <span style="color:#c00;font-weight:bold;">20 minuten</span> straftijd.</div>
<div style="display:flex;gap:15px;justify-content:center;">
<button onclick="confirmHint()" style="font-size:1.1em;background:#1a0505;color:#c00;border:2px solid #800;border-radius:8px;padding:10px 30px;cursor:pointer;">Ja, geef hint</button>
<button onclick="cancelHint()" style="font-size:1.1em;background:#1a1a1a;color:#888;border:2px solid #333;border-radius:8px;padding:10px 30px;cursor:pointer;">Annuleren</button>
</div>
</div>

<!-- Background music player - persists across iframe changes -->
<audio id="tbbx-music" src="soundofsilence.mp3" preload="auto" loop></audio>

<script type="text/javascript">
// URL base for communicating with The BlackBox
var theBlackBoxBase = "http://127.0.0.1:5000/";

// Start background music
function startMusic() {
	let audio = document.getElementById("tbbx-music");
	if (audio.paused) {
		audio.play().catch(function(e) { console.log("Music autoplay blocked:", e); });
	}
}

// Stop background music
function stopMusic() {
	let audio = document.getElementById("tbbx-music");
	audio.pause();
	audio.currentTime = 0;
}

// Set WiFi icon colour
function updateWiFiIcon(connected) {
	// Get img element
	let icon_wifi_connected = document.getElementById("icon-wifi-connected");

	if (connected) {
		icon_wifi_connected.className = "tbbx-wifi-connected";
	} else {
		icon_wifi_connected.className = "";
	}
}

// Set player name in the banner
function setBannerPlayerName(playerName) {
	document.getElementById("tbbx-player-text").innerHTML = playerName
}

// Fetch banner data
async function fetchBannerData() {
	// Create banner information URL
	let urlBannerInformation = theBlackBoxBase+"banner";
	try {
		// Get banner information
		//console.log(urlBannerInformation)
		let response = await fetch(urlBannerInformation);

		// Process response
		responseJSON = await response.json();
		//console.log(responseJSON);

		// Update banner
		if (responseJSON.connected) {
			updateWiFiIcon(true);
		} else {
			updateWiFiIcon(false);
		}
		setBannerPlayerName(responseJSON.player)
	} catch (error) {
		// Print error
		//console.log(error);
	}
}

// Logout player
async function playerLogout() {
	// Create player logout URL
	let urlPlayerLogout = theBlackBoxBase+"player/logout";
	try {
		// Get banner information
		//console.log(urlPlayerLogout)
		let response = await fetch(urlPlayerLogout);

		// Process response
		responseJSON = await response.json();
		//console.log(responseJSON);
	} catch (error) {
		// Print error
		//console.log(error);
	}

	// Stop music on logout
	stopMusic();
}

setInterval(fetchBannerData, 500);

// Tip system - poll for admin hints
var lastTipTimestamp = 0;
var tipHideTimer = null;
function checkForTips() {
	fetch('/theblackbox/tip.php')
		.then(function(r) { return r.json(); })
		.then(function(data) {
			if (data.tip && data.timestamp > lastTipTimestamp) {
				lastTipTimestamp = data.timestamp;
				document.getElementById('tip-message').textContent = data.tip;
				var popup = document.getElementById('tip-popup');
				popup.style.display = 'block';
				popup.style.animation = 'tipPulse 2s ease-in-out infinite';
				if (tipHideTimer) clearTimeout(tipHideTimer);
				tipHideTimer = setTimeout(function() {
					popup.style.display = 'none';
				}, 10000);
			}
		})
		.catch(function(e) {});
}
setInterval(checkForTips, 2000);

// ========== HINT REQUEST SYSTEM ==========
function requestHint() {
	document.getElementById('hint-confirm').style.display = 'block';
}

function cancelHint() {
	document.getElementById('hint-confirm').style.display = 'none';
}

function confirmHint() {
	document.getElementById('hint-confirm').style.display = 'none';
	fetch(theBlackBoxBase + 'challenge/hint')
		.then(function(r) { return r.json(); })
		.then(function(data) {
			if (data.error) {
				var msg = 'Geen hints beschikbaar';
				if (data.error === 'no more hints') msg = 'Alle hints zijn al gebruikt voor deze challenge!';
				if (data.error === 'no player logged in') msg = 'Eerst inloggen!';
				if (data.error === 'no hints available') msg = 'Deze challenge heeft geen hints.';
				document.getElementById('tip-message').textContent = msg;
				var popup = document.getElementById('tip-popup');
				popup.style.display = 'block';
				popup.style.animation = 'tipPulse 2s ease-in-out infinite';
				if (tipHideTimer) clearTimeout(tipHideTimer);
				tipHideTimer = setTimeout(function() { popup.style.display = 'none'; }, 5000);
			} else {
				var hintText = 'Hint ' + data.hint_number + '/' + data.hints_total + ': ' + data.hint;
				document.getElementById('tip-message').textContent = hintText;
				var popup = document.getElementById('tip-popup');
				popup.style.display = 'block';
				popup.style.animation = 'tipPulse 2s ease-in-out infinite';
				if (tipHideTimer) clearTimeout(tipHideTimer);
				tipHideTimer = setTimeout(function() { popup.style.display = 'none'; }, 15000);
			}
		})
		.catch(function(e) {
			document.getElementById('tip-message').textContent = 'Fout bij ophalen hint.';
			var popup = document.getElementById('tip-popup');
			popup.style.display = 'block';
			if (tipHideTimer) clearTimeout(tipHideTimer);
			tipHideTimer = setTimeout(function() { popup.style.display = 'none'; }, 5000);
		});
}
</script>

</body>
</html>
