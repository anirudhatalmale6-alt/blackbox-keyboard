<html>
<head>
<title>The BlackBox</title>
<link rel="stylesheet" type="text/css" href="theblackbox.css">
</head>
<body id="tbbx-body">
<div id="tbbx-banner">

	<span id="tbbx-status"><img id="icon-wifi-connected" class="" src="icons/wifi-grey.32x32.png"> </span>
	<span id="tbbx-player"><center id="tbbx-player-text"></center></span>
	<span id="tbbx-logout"><button id="button-player-logout" onclick="playerLogout()"><img id="icon-player-logout" class="" src="icons/power-black.32x32.png" /></button></span>
</div>
<div id="tbbx-challenge"> <iframe id="tbbx-challenge-frame" height="100%" width="100%" style="border: 0px;" allowfullscreen></iframe> </div>

<!-- Tip popup overlay -->
<div id="tip-popup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,#1a0a0a 0%,#2a0a0a 100%);border:3px solid #c00;border-radius:15px;padding:30px 40px;max-width:80%;max-height:60%;z-index:99999;box-shadow:0 0 50px rgba(200,0,0,0.5),inset 0 0 30px rgba(0,0,0,0.5);">
<style>
@keyframes tipPulse { 0%,100%{box-shadow:0 0 50px rgba(200,0,0,0.5),inset 0 0 30px rgba(0,0,0,0.5)} 50%{box-shadow:0 0 70px rgba(200,0,0,0.8),inset 0 0 30px rgba(0,0,0,0.5)} }
</style>
<div style="text-align:center;">
<div style="font-size:1.5em;color:#fc0;margin-bottom:15px;text-transform:uppercase;letter-spacing:3px;">- - - HINT - - -</div>
<div id="tip-message" style="font-size:1.8em;color:#fff;line-height:1.4;margin-bottom:20px;"></div>
<div style="font-size:0.9em;color:#666;margin-top:15px;">Verdwijnt automatisch...</div>
</div>
</div>

<!-- Background music player - persists across iframe changes -->
<audio id="tbbx-music" src="soundofsilence.mp3" preload="auto" loop></audio>

<script type="text/javascript">
// URL base for communicating with The BlackBox
var theBlackBoxBase = "http://127.0.0.1:5000/";

// Start background music
function startMusic() {
	let audio = document.getElementById("tbbx-music");
	if (audio.paused) {
		audio.play().catch(function(e) { console.log("Music autoplay blocked:", e); });
	}
}

// Stop background music
function stopMusic() {
	let audio = document.getElementById("tbbx-music");
	audio.pause();
	audio.currentTime = 0;
}

// Set WiFi icon colour
function updateWiFiIcon(connected) {
	// Get img element
	let icon_wifi_connected = document.getElementById("icon-wifi-connected");

	if (connected) {
		icon_wifi_connected.className = "tbbx-wifi-connected";
	} else {
		icon_wifi_connected.className = "";
	}
}

// Set player name in the banner
function setBannerPlayerName(playerName) {
	document.getElementById("tbbx-player-text").innerHTML = playerName
}

// Fetch banner data
async function fetchBannerData() {
	// Create banner information URL
	let urlBannerInformation = theBlackBoxBase+"banner";
	try {
		// Get banner information
		//console.log(urlBannerInformation)
		let response = await fetch(urlBannerInformation);

		// Process response
		responseJSON = await response.json();
		//console.log(responseJSON);

		// Update banner
		if (responseJSON.connected) {
			updateWiFiIcon(true);
		} else {
			updateWiFiIcon(false);
		}
		setBannerPlayerName(responseJSON.player)
	} catch (error) {
		// Print error
		//console.log(error);
	}
}

// Logout player
async function playerLogout() {
	// Create player logout URL
	let urlPlayerLogout = theBlackBoxBase+"player/logout";
	try {
		// Get banner information
		//console.log(urlPlayerLogout)
		let response = await fetch(urlPlayerLogout);

		// Process response
		responseJSON = await response.json();
		//console.log(responseJSON);
	} catch (error) {
		// Print error
		//console.log(error);
	}

	// Stop music on logout
	stopMusic();
}

setInterval(fetchBannerData, 500);

// Tip system - poll for admin hints
var lastTipTimestamp = 0;
var tipHideTimer = null;
function checkForTips() {
	fetch('/theblackbox/tip.php')
		.then(function(r) { return r.json(); })
		.then(function(data) {
			if (data.tip && data.timestamp > lastTipTimestamp) {
				lastTipTimestamp = data.timestamp;
				document.getElementById('tip-message').textContent = data.tip;
				var popup = document.getElementById('tip-popup');
				popup.style.display = 'block';
				popup.style.animation = 'tipPulse 2s ease-in-out infinite';
				if (tipHideTimer) clearTimeout(tipHideTimer);
				tipHideTimer = setTimeout(function() {
					popup.style.display = 'none';
				}, 10000);
			}
		})
		.catch(function(e) {});
}
setInterval(checkForTips, 2000);
</script>

</body>
</html>
